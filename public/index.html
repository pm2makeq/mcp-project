<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•™ìƒ ê´€ë¦¬ RAG ê¸°ë°˜ ì±—ë´‡</title>
  <style>
  body {
    font-family: sans-serif;
    max-width: 600px;
    margin: 2rem auto;
  }
  #chat {
    border: 1px solid #ccc;
    padding: 1rem;
    height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
  }

  #chat .message {
    display: flex;
    align-items: flex-start;
    margin: .5rem 0;
    width: 100%;
  }

  #chat .message .avatar {
    font-size: 1.5rem;
    margin: 0 .5rem;
  }

  #chat .message .text {
    padding: .5rem 1rem;
    border-radius: .5rem;
    line-height: 1.4;
    max-width: 80%;
    word-break: break-word;
  }

  #chat .message.bot {
    justify-content: flex-start;
  }
  #chat .message.bot .text {
    background: #f0f0f0;
    color: #333;
  }

  #chat .message.user {
    justify-content: flex-end;
  }
  #chat .message.user .text {
    background: #d0eaff;
    color: #000;
  }
  
  /* â”€â”€ ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ ì¡°ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  form {
    display: flex;
    width: 100%;        /* ì»¨í…Œì´ë„ˆ í­ì— ë§ì¶¤ */
    margin-top: 1rem;
  }
  input {
    flex: 1;
    padding: .75rem;    /* ë†’ì´ ì¦ê°€ */
    font-size: 1.25rem; /* ì•½ +5px (ê¸°ì¡´ 1rem â‰ˆ16px â†’ 1.25rem â‰ˆ20px) */
    border: 1px solid #ccc;
    border-radius: .25rem 0 0 .25rem;
    outline: none;
  }
  button {
    padding: .75rem 1.25rem;
    font-size: 1.25rem;
    border: 1px solid #ccc;
    border-left: none;
    border-radius: 0 .25rem .25rem 0;
    background: #007bff;
    color: #fff;
    cursor: pointer;
  }
  button:hover {
    background: #0056b3;
  }
</style>

</head>
<body>
  <h2>í•™ìƒ ê´€ë¦¬ RAG ê¸°ë°˜ ì±—ë´‡</h2>
  <div id="chat"></div>

  <form id="inputForm">
    <input id="messageInput" type="text" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" required />
    <button type="submit">ì „ì†¡</button>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const chat = document.getElementById('chat');
      const form = document.getElementById('inputForm');
      const input = document.getElementById('messageInput');

      function appendMessage(who, text) {
        const wrapper = document.createElement('div');
        wrapper.classList.add('message', who);

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = who === 'bot' ? 'ğŸ¤–' : 'ğŸ‘¤';

        const content = document.createElement('div');
        content.className = 'text';
        content.textContent = text;

        if (who === 'bot') {
          wrapper.append(avatar, content);
        } else {
          wrapper.append(content, avatar);
        }
        chat.appendChild(wrapper);
        chat.scrollTop = chat.scrollHeight;
      }

      function updateLastBot(text) {
        const bots = chat.querySelectorAll('.bot .text');
        const last = bots[bots.length - 1];
        if (last) last.textContent = text;
        chat.scrollTop = chat.scrollHeight;
          }

          // ì´ˆê¸° ì¸ì‚¬ ë©”ì‹œì§€
          appendMessage('bot', 'ì•ˆë…•í•˜ì„¸ìš” ì €ëŠ” í•™ìƒê´€ë¦¬í•˜ëŠ” ì±—ë´‡ì…ë‹ˆë‹¤.\në¬´ìŠ¨ ì •ë³´ê°€ í•„ìš”í•˜ì‹ ê°€ìš”?');
          
          async function callAsk(question, tables = []) {
            tables.push("students");
            const resp = await fetch('/proxy/8080/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, tables }),
      });

      let data;
      try {
        data = await resp.json();
      } catch (e) {
        return {
          sql: 'ì‘ë‹µí•  ìˆ˜ ì—†ëŠ” ìš”ì²­ì…ë‹ˆë‹¤.',
          rows: 'ì‘ë‹µí•  ìˆ˜ ì—†ëŠ” ìš”ì²­ì…ë‹ˆë‹¤.',
          summary: 'ì„œë²„ ì‘ë‹µì„ í•´ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        };
      }

      // ì—ëŸ¬ ì‘ë‹µ
      if (typeof data !== 'object' || data === null || 'error' in data || 'note' in data) {
        return {
          sql: 'ì‘ë‹µí•  ìˆ˜ ì—†ëŠ” ìš”ì²­ì…ë‹ˆë‹¤.',
          rows: 'ì‘ë‹µí•  ìˆ˜ ì—†ëŠ” ìš”ì²­ì…ë‹ˆë‹¤.',
          summary: data?.note || data?.error || 'ì‘ë‹µí•  ìˆ˜ ì—†ëŠ” ìš”ì²­ì…ë‹ˆë‹¤.',
        };
      }

      // ì •ìƒ ì‘ë‹µ
      return {
        sql: typeof data.sql === 'string' ? data.sql : 'ì‘ë‹µí•  ìˆ˜ ì—†ëŠ” ìš”ì²­ì…ë‹ˆë‹¤.',
        rows: Array.isArray(data.rows) && data.rows.length > 0 ? data.rows : 'ì‘ë‹µí•  ìˆ˜ ì—†ëŠ” ìš”ì²­ì…ë‹ˆë‹¤.',
        summary: typeof data.summary === 'string' && data.summary.trim()
          ? data.summary
          : 'ì‘ë‹µí•  ìˆ˜ ì—†ëŠ” ìš”ì²­ì…ë‹ˆë‹¤.',
      };
      }

      form.addEventListener('submit', async e => {
        e.preventDefault();
        const question = input.value.trim();
        if (!question) return;

        appendMessage('user', question);
		
        appendMessage('bot', 'ğŸ•‘ ì²˜ë¦¬ ì¤‘â€¦');
        input.value = '';
        // 1) ì¸ì‚¬ë§ ê°ì§€
        if (/^(ì•ˆë…•|ì•ˆë…•í•˜ì„¸ìš”|ë°˜ê°‘ìŠµë‹ˆë‹¤|ë°˜ê°€)/.test(question)) {
          appendMessage('bot', "ì•ˆë…•í•˜ì„¸ìš”! í•™ìƒ ì„±ì  ê´€ë¦¬ ì±—ë´‡ì…ë‹ˆë‹¤.");
          return;
        }
		
        try {
          const { sql, rows, summary } = await callAsk(question, ['']);

          // â— ì—ëŸ¬ ì‘ë‹µì´ë©´ throw
          if (typeof summary !== 'string' || !summary.trim()) {
            throw new Error('ìš”ì•½ ê²°ê³¼ê°€ ë¹„ì–´ ìˆê±°ë‚˜ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          }

          updateLastBot(
            'âœ… ìƒì„±ëœ SQL:\n' + sql +
            '\n\nâœ… ë°ì´í„°:\n' + JSON.stringify(rows, null, 2) +
            '\n\nâœ… ìš”ì•½:\n' + summary
          );
        } catch (err) {
          updateLastBot('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + err);
        }
      });
    });
  </script>
</body>
</html>
